#apriori
library(arules)
library(arulesViz)


"
Antecedent 	Consequent
A 	          0
A           	0
A 	          1
A  	          0
B 	          1
B 	          0
B 	          1
                  Support      Confidence     Lift
rule 1: A -> 0      3/7           3/4       (3/4)/(4/7)
rule 2: B -> 1      2/7           2/3       (2/3)/(3/7)

Support:
 How frequent an itemset appears in the dataset.
 The proportion of transactions wich contains itemset X

Confidence:
 How often the rule has been found to be true
 The confidence value of a rule, X -> Y is the proportion of transactions that contains X
 which also contains Y.

Lift:
 the ratio of the observed support to the expcted support if X and Y are independent.
"
Apriori <- setRefClass("AssociationRules",
                        fields = list(dataset = "data.frame",
                                     flatdata = "matrix",
                                     ruleset = "list"),
                        methods = list(
                          run_apriori = function(){
                            ruleset <<- list("rules" = apriori(flatdata, parameter=list(support=0.25, confidence=0.5)))
                          },
                          plot_graph = function(n = 20){
                            plot(head(sort(ruleset$rules, by = "lift"), n), method = "graph", control=list(cex=.8), interactive=T)
                          },
                          get_topN = function(n=20){
                            return(inspect(head(sort(ruleset$rules), n)))
                        },
                          Data_clean = function(split="sbs"){
                            if(split == "sbs"){
                              extendCollumns <- function(column, starting_matrix, column_name){

                                cluster_to_true_false <-  function(val, clusternum){
                                if(is.na(val) || val != clusternum) return(0)
                                  else return(1)
                                }

                                for(i in levels(as.factor(column))){
                                  changed_column <- sapply(column, cluster_to_true_false, clusternum=i)
                                  starting_matrix <- cbind(starting_matrix, changed_column)
                                  colnames(starting_matrix)[ncol(starting_matrix)] <- paste(column_name, ".", i, sep="")
                                }
                                return(starting_matrix)
                              }
                              starting_matrix <- matrix(nrow = nrow(dataset))
                              COLUMNS <- colnames(dataset)
                              for(i in 1:ncol(dataset)){
                                starting_matrix <- extendCollumns(dataset[,i], starting_matrix, COLUMNS[i])
                              }
                              flatdata <<- starting_matrix[,2: ncol(starting_matrix)]
                            }else #this else is for testing purposes with pre-formatted data
                              flatdata <<- as.matrix(dataset)
                          }
                       )
)




test <- Apriori$new(dataset = dat)

test$Data_clean("")
test$run_apriori()
test$get_topN(20)
test$plot_graph(20)



#load a table
dat <- read.csv("/home/joris/Downloads/Wide_Association_Matrix.csv")
dat <- read.csv("/home/joris/Downloads/testmatrix.csv")
rownames(dat) <- dat[,1]
dat[,1] <- NULL



